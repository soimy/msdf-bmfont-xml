# macOS 安全问题解决方案总结

## 问题背景

在 macOS 系统上，从网络下载的可执行文件会被 Apple 的安全机制阻止运行，包括：
- **Gatekeeper**: 防止运行未经认证的应用程序
- **隔离属性 (Quarantine)**: 标记从网络下载的文件
- **代码签名检查**: 验证应用程序的完整性和来源

## 实现的解决方案

### 1. 自动处理机制
安装脚本现在包含以下自动处理步骤：

```javascript
// 移除隔离属性
execSync(`xattr -d com.apple.quarantine "${binaryPath}"`)

// 清除所有扩展属性  
execSync(`xattr -c "${binaryPath}"`)

// 应用临时代码签名
execSync(`codesign --force --deep --sign - "${binaryPath}"`)
```

### 2. 智能检测和修复
- 检测现有二进制文件是否可执行
- 如果失败，自动尝试修复 macOS 安全问题
- 提供详细的用户指导

### 3. 用户友好的错误处理
如果自动修复失败，提供清晰的手动解决步骤：
- 系统偏好设置操作指南
- 命令行解决方案
- 企业环境处理建议

## 使用方法

### 正常安装
```bash
npm install msdf-bmfont-xml
```
安装过程中会自动处理 macOS 安全问题。

### 手动修复现有安装
```bash
npm run install
```

### 跳过安全处理
```bash
SKIP_MACOS_SECURITY=1 npm install
```

## 技术细节

### 支持的操作
1. **隔离属性移除**: 移除 `com.apple.quarantine` 属性
2. **代码签名**: 应用 ad-hoc 签名绕过部分 Gatekeeper 检查
3. **权限设置**: 确保二进制文件有执行权限
4. **验证测试**: 测试二进制文件是否可正常运行

### 错误处理
- 优雅处理 `codesign` 不可用的情况
- 提供详细的故障排除指导
- 不因安全处理失败而中断安装过程

### 平台兼容性
- 仅在 macOS 系统上执行安全处理
- 其他平台正常设置权限
- 支持 Intel 和 Apple Silicon Mac

## 安全考虑

1. **最小权限原则**: 仅应用必要的修改
2. **透明操作**: 详细记录所有操作步骤
3. **用户控制**: 提供跳过选项
4. **非破坏性**: 不会损害系统安全设置

## 用户体验改进

- ✅ 大多数用户无需手动干预
- ✅ 清晰的错误信息和解决指导
- ✅ 保持与现有工作流的兼容性
- ✅ 支持企业环境部署需求

这个解决方案确保了 msdf-bmfont-xml 包能够在 macOS 上无缝工作，同时保持系统安全性。
